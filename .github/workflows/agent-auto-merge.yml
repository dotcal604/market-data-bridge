name: Agent PR Auto-Merge

# Trigger on PRs from Copilot and Codex agent branches
on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  typecheck-and-merge:
    # Only run on agent branches
    if: |
      startsWith(github.head_ref, 'copilot/') ||
      startsWith(github.head_ref, 'codex/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        id: typecheck
        run: npx tsc --noEmit 2>&1 | tee /tmp/tsc-output.txt
        continue-on-error: true

      - name: Check merge conflicts
        id: conflicts
        run: |
          git fetch origin main
          if git merge-tree $(git merge-base origin/main HEAD) origin/main HEAD | grep -q '<<<<<<'; then
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
          else
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Auto-merge if clean
        if: steps.typecheck.outcome == 'success' && steps.conflicts.outputs.has_conflicts == 'false' && !github.event.pull_request.draft
        uses: actions/github-script@v7
        with:
          script: |
            // Squash merge
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash',
            });

            console.log(`Auto-merged PR #${context.issue.number}`);

            // Delete branch
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${context.payload.pull_request.head.ref}`,
              });
            } catch (e) {
              console.log('Branch already deleted or protected');
            }

      - name: Comment if blocked
        if: steps.typecheck.outcome == 'failure' || steps.conflicts.outputs.has_conflicts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const typecheck = '${{ steps.typecheck.outcome }}';
            const conflicts = '${{ steps.conflicts.outputs.has_conflicts }}';
            const fs = require('fs');

            let body = '## Agent PR Auto-Merge Blocked\n\n';

            if (typecheck === 'failure') {
              const tscOutput = fs.readFileSync('/tmp/tsc-output.txt', 'utf8').slice(0, 2000);
              body += `### Type Check Failed\n\`\`\`\n${tscOutput}\n\`\`\`\n\n`;
            }

            if (conflicts === 'true') {
              body += '### Merge Conflicts Detected\nThis PR has merge conflicts with main. Needs manual resolution.\n\n';
            }

            body += '*Auto-generated by [agent-auto-merge.yml](.github/workflows/agent-auto-merge.yml)*';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
