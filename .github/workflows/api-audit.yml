name: API Dependency Audit

on:
  schedule:
    # Every Monday at 9:00 AM ET (14:00 UTC)
    - cron: '0 14 * * 1'
  workflow_dispatch: # Manual trigger

permissions:
  issues: write
  contents: read

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run API audit
        id: audit
        continue-on-error: true
        run: node scripts/api-audit.mjs

      - name: Create issue if problems found
        if: steps.audit.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const critical = '${{ steps.audit.outputs.critical_count }}' || '0';
            const warnings = '${{ steps.audit.outputs.warning_count }}' || '0';
            const findings = `${{ steps.audit.outputs.findings }}` || 'See workflow logs for details.';

            // Check for existing open audit issue
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'api-audit',
              state: 'open',
            });

            const title = `API Audit: ${critical} critical, ${warnings} warnings â€” ${new Date().toISOString().split('T')[0]}`;

            const body = [
              '## API Dependency Audit Results\n',
              `**Run date**: ${new Date().toISOString()}`,
              `**Critical**: ${critical}`,
              `**Warnings**: ${warnings}\n`,
              '### Findings\n',
              findings,
              '\n---',
              '*Auto-generated by [api-audit.yml](.github/workflows/api-audit.yml). Edit `scripts/api-audit.mjs` to update deprecation calendar.*',
            ].join('\n');

            if (existing.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.data[0].number,
                body: `## Updated: ${new Date().toISOString().split('T')[0]}\n\n${findings}`,
              });
              console.log(`Updated existing issue #${existing.data[0].number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['api-audit'],
              });
              console.log('Created new audit issue');
            }
